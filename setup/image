#!/bin/bash
[ -e /etc/kiosk/setup ] && source /etc/kiosk/setup

EXIT_CODE=0
[ -n "$SETUP_HASHWORD" ] && {
	declare -x SETUP_HASHWORD
	[ -e "/etc/kiosk/setup" ] || {
		echo "No setup found"
		exit 1
	}
	pushd / > /dev/null
	echo "Downloading initial system image"

	wget --show-progress \
		-qcO /dev/stdout "$SETUP_DOMAIN_IMAGE_URL" \
		| openssl enc \
			-d -pbkdf2 \
			-iter 100000 \
			-pass env:SETUP_HASHWORD \
		| tar xj
	EXIT_CODE=$?
	popd > /dev/null
}
exit $EXIT_CODE
