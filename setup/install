#!/bin/bash

. /etc/profile
. setup/promote

PERM_USER="$(id -nu 1000)"
PERM_GROUP="$(id -ng 1000)"
EXEC_FOLDER="$(pwd)"

cat <<- EOF
	Welcome to the SD/IO Installer
	Please wait while we freshen things up a bit
EOF

until [ -e $(pwd)/.git ]; do
	cd ..
	[ "$(pwd)" == "/" ] && {
		cat <<- EOF
			Could not find the GIT repository while searching up the directory tree
			please try again from the setup or kiosk-helpers directory.
		EOF
		cd "$EXEC_FOLDER"
		exit 1
	}
done

SETUP_LOCATION="$(pwd)/setup"

echo "Setting folder permissions"
chmod a-x,u+rw,go-rw /home/$PERM_USER/.ssh/*
chown -R "$PERM_USER:$PERM_GROUP" -- .
chmod -R a+rw .

echo "Updating Source"
sudo -Eu "$PERM_USER" -- git reset --hard
sudo -Eu "$PERM_USER" -- git pull

echo "Continuing Setup with fresh source"
chmod a+x setup/postgit
source setup/postgit
