#!/bin/bash
function bail() {
	echo "$@"
	exit 1
}

source /etc/kiosk/setup
source /usr/local/lib/kiosk/administration

SETUP_HOSTNAME=${SETUP_USER:=kooky}-$(printf "%02i" ${SETUP_KIOSK_ID:=1})

AUTH_KEYS="/home/${SETUP_USER}/.ssh/authorized_keys"
wget -qcO "${AUTH_KEYS}" "http://${SETUP_KIOSK_SERVER}:8080/keys"

chown "${SETUP_USER}:${SETUP_USER}" "${AUTH_KEYS}"
chmod u+rw,og-rwx "${AUTH_KEYS}"

rm /etc/X11/sawfish/site-init.d/00debian.jl &> /dev/null
rm /etc/X11/sawfish/site-init.d/00menu.jl &> /dev/null

update-initramfs -u
update-grub

systemctl daemon-reload &> /dev/null || bail "Could not reload daemons"
systemctl enable management.service &> /dev/null || bail "management service not configured"
systemctl enable display-manager.service &> /dev/null || bail "Display manager not configured"
systemctl disable cloud-init &> /dev/null || bail "Could not disable cloud init"

sudo -iu "${SETUP_USER}" -- systemctl --global daemon-reload &> /dev/null || bail "Could not reload user daemons"
sudo -iu "${SETUP_USER}" -- systemctl --global enable remote &> /dev/null || bail "Could not enable remote unit"

restorecon /etc/hosts
restorecon /etc/hostname
USER_ID=$(id -u $SETUP_USER)
USER_PATH=$(dbus-send --print-reply=literal --system --dest=org.freedesktop.Accounts /org/freedesktop/Accounts org.freedesktop.Accounts.FindUserById int64:$USER_ID)

dbus-send --print-reply --system --dest=org.freedesktop.Accounts $USER_PATH org.freedesktop.Accounts.User.SetXSession string:'kiosk'

make-key > "${KIOSK_PROFILE}/.nonce"
rm /var/www/session &>/dev/null
ln -s "${KIOSK_PROFILE}/.nonce" /var/www/session

exit 0
