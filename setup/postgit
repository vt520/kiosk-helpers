#!/bin/bash
echo $EXEC_USER_ID
echo "Configuring permissions"

cd "$SETUP_LOCATION"
cd ..

chmod +x setup/permissions
setup/permissions

echo "Checking installed packages"
setup/packages

echo "Determining install mode"
SETUP_CONFIG="/etc/kiosk/setup"

[ -e "$SETUP_CONFIG" ] && INSTALL_MODE="Upgrade"

[ "${INSTALL_MODE}" == "Upgrade" ] && {
	echo "Creating patchset"
	setup/patches
}

echo "Configuring SD/OS Build"
setup/prompts

echo "Creating System Tarball"

TEMP_TARBALL=$(tempfile)
SYSTEM_TARBALL=/etc/kiosk.last-system-image.tbz

[ -e "$SYSTEM_TARBALL" ] && mv "$SYSTEM_TARBALL" "${SYSTEM_TARBALL}.old"
tar cjpPf "$TEMP_TARBALL" -- *
mv "$TEMP_TARBALL" "$SYSTEM_TARBALL"

cat <<- EOF
Preparing to apply image;
type "YES PLEASE" at the prompt to install;
anything else for a rather ungraceful exit
EOF

read -p "INSTALL> " -ie PROMPT

[ "$PROMPT" == "YES PLEASE" ] && {
	cd /
	tar xjpPf $SYSTEM_TARBALL
}
